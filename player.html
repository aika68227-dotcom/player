<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fluid Player - Notch Support</title>
    
    <!-- Fluid Player CDN -->
    <script src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>

    <style>
        /* CSS Anda tidak diubah, sudah sempurna */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif;
        }
        #video-container {
            width: 100vw; height: 100vh; position: relative; background: #000;
        }
        video { 
            width: 100%; height: 100%; object-fit: contain; 
        }
        :root { --primary-color: #87CEEB; }
        .fluid_video_wrapper .fluid_button svg { fill: var(--primary-color) !important; }
        .fluid_video_wrapper .fluid_controls_progress_played { background-color: var(--primary-color) !important; }
        .fluid_video_wrapper .fluid_initial_play_button_inner { background-color: var(--primary-color) !important; }
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding-top: max(15px, env(safe-area-inset-top)); 
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            padding-bottom: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            color: var(--primary-color);
            font-weight: bold; letter-spacing: 1px; font-size: 14px;
            z-index: 100; pointer-events: none; display: flex; 
            align-items: center; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<div id="video-container">
    <div class="top-bar" id="title-display">LOADING...</div>
    <!-- Tag <source> sengaja dihilangkan karena Fluid Player akan mengisinya dari JavaScript -->
    <video id="my-video" playsinline></video>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedId = urlParams.get('id');

        if (encodedId) {
            try {
                const data = JSON.parse(atob(encodedId));
                
                // =================================================================
                // PERBAIKAN UTAMA ADA DI SINI
                // =================================================================

                // 1. Siapkan daftar sumber video untuk Fluid Player
                let playerSources = [];
                if (data.sources && data.sources.length > 0) {
                    playerSources = data.sources.map((source, index) => ({
                        url: source.file,
                        label: source.label,
                        // Tandai resolusi pertama sebagai default
                        isDefault: index === 0 
                    }));
                } else {
                    document.getElementById('title-display').innerText = "ERROR: Tidak ada link video.";
                    return; 
                }
                
                // 2. Set judul dari label video pertama
                const videoTitle = data.sources[0].label || "VIDEO";
                document.getElementById('title-display').innerText = "WATCHING: " + videoTitle;
                
                // 3. Set Subtitle (tidak berubah)
                if(data.s) {
                    const videoEl = document.getElementById('my-video');
                    const track = document.createElement('track');
                    track.kind = 'subtitles';
                    track.label = 'Indonesia';
                    track.srclang = 'id';
                    track.src = data.s;
                    track.default = true;
                    videoEl.appendChild(track);
                }

                // 4. Konfigurasi Iklan (tidak berubah)
                let vastSettings = {};
                if (data.a) {
                    vastSettings = {
                        adList: [{ roll: 'preRoll', vastTag: data.a, timer: 5 }],
                        skipButtonCaption: 'Lewati Iklan ([seconds])',
                        skipButtonClick: true, adText: 'Sponsor', adCTAText: 'Buka',
                        allowVPAID: true, vastTimeout: 10000, maxAllowedVastTagRedirects: 8,
                        vastAdvanced: { videoExtensions: ['mp4', 'webm', 'ogg', 'm3u8'], noVastAfterCa: false }
                    };
                }

                // 5. Inisialisasi Fluid Player dengan KONFIGURASI YANG BENAR
                var player = fluidPlayer('my-video', {
                    // KESALAHAN SEBELUMNYA ADA DI SINI. `sources` harus di level utama.
                    sources: playerSources,
                    
                    layoutControls: {
                        primaryColor: "#87CEEB",
                        fillToContainer: true,
                        posterImage: '', 
                        autoPlay: false,
                        playButtonShowing: true,
                        playPauseAnimation: true,
                        allowTheatre: false,
                        keyboardControl: true,
                        layout: 'default',
                        controlBar: {
                            autoHide: true,
                            autoHideTimeout: 3,
                            animated: true
                        }
                    },
                    vastOptions: vastSettings
                });
                
                // Logika Judul (tidak berubah)
                player.on('play', () => document.getElementById('title-display').style.opacity = '0');
                player.on('pause', () => document.getElementById('title-display').style.opacity = '1');
                player.on('ended', () => document.getElementById('title-display').style.opacity = '1');

            } catch (e) {
                console.error("Error saat memuat data player:", e);
                document.getElementById('title-display').innerText = "ERROR: Data tidak valid.";
            }
        }
    });
</script>

</body>
</html>
