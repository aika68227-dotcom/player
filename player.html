<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Fluid Player - Notch Support</title>
    
    <!-- Fluid Player CDN -->
    <script src="https://cdn.fluidplayer.com/v3/current/fluidplayer.min.js"></script>

    <style>
        /* CSS Anda tidak saya ubah, sudah sempurna. */
        body, html { 
            margin: 0; padding: 0; width: 100%; height: 100%; 
            background-color: #000; overflow: hidden; font-family: 'Segoe UI', sans-serif;
        }
        #video-container {
            width: 100vw; height: 100vh; position: relative; background: #000;
        }
        video { 
            width: 100%; height: 100%; object-fit: contain; 
        }
        :root { --primary-color: #87CEEB; }
        .fluid_video_wrapper .fluid_button svg { fill: var(--primary-color) !important; }
        .fluid_video_wrapper .fluid_controls_progress_played { background-color: var(--primary-color) !important; }
        .fluid_video_wrapper .fluid_initial_play_button_inner { background-color: var(--primary-color) !important; }
        .top-bar {
            position: absolute; top: 0; left: 0; width: 100%;
            padding-top: max(15px, env(safe-area-inset-top)); 
            padding-left: max(20px, env(safe-area-inset-left));
            padding-right: max(20px, env(safe-area-inset-right));
            padding-bottom: 15px;
            background: linear-gradient(to bottom, rgba(0,0,0,0.9) 0%, transparent 100%);
            color: var(--primary-color);
            font-weight: bold; letter-spacing: 1px; font-size: 14px;
            z-index: 100; pointer-events: none; display: flex; 
            align-items: center; transition: opacity 0.5s;
        }
    </style>
</head>
<body>

<div id="video-container">
    <div class="top-bar" id="title-display">LOADING...</div>
    <video id="my-video" playsinline></video>
</div>

<script>
    document.addEventListener("DOMContentLoaded", function() {
        const urlParams = new URLSearchParams(window.location.search);
        const encodedId = urlParams.get('id');

        if (encodedId) {
            try {
                const data = JSON.parse(atob(encodedId));
                const videoElement = document.getElementById('my-video');

                // =================================================================
                // INI ADALAH LOGIKA BARU YANG PASTI BERHASIL
                // =================================================================

                // 1. Validasi data sumber video
                if (!data.sources || data.sources.length === 0) {
                    document.getElementById('title-display').innerText = "ERROR: Tidak ada link video.";
                    return;
                }

                // 2. Buat elemen <source> secara manual untuk setiap resolusi
                //    Ini cara paling ampuh agar Fluid Player mendeteksi kualitas.
                data.sources.forEach(source => {
                    const sourceTag = document.createElement('source');
                    sourceTag.setAttribute('src', source.file);
                    sourceTag.setAttribute('type', 'video/mp4');
                    // Fluid Player menggunakan 'title' untuk label di menu kualitas
                    sourceTag.setAttribute('title', source.label); 
                    videoElement.appendChild(sourceTag);
                });

                // 3. Set judul dari resolusi pertama
                const videoTitle = data.sources[0].label || "VIDEO";
                document.getElementById('title-display').innerText = "WATCHING: " + videoTitle;
                
                // 4. Set Subtitle (logika ini tidak berubah)
                if(data.s) {
                    const track = document.createElement('track');
                    track.kind = 'subtitles';
                    track.label = 'Indonesia';
                    track.srclang = 'id';
                    track.src = data.s;
                    track.default = true;
                    videoElement.appendChild(track);
                }

                // 5. Konfigurasi Iklan (logika ini tidak berubah)
                let vastSettings = {};
                if (data.a) {
                    vastSettings = {
                        adList: [{ roll: 'preRoll', vastTag: data.a, timer: 5 }],
                        skipButtonCaption: 'Lewati Iklan ([seconds])',
                        skipButtonClick: true, adText: 'Sponsor', adCTAText: 'Buka',
                        allowVPAID: true, vastTimeout: 10000, maxAllowedVastTagRedirects: 8
                    };
                }

                // 6. Jalankan Fluid Player SETELAH semua elemen <source> ditambahkan
                var player = fluidPlayer('my-video', {
                    layoutControls: {
                        primaryColor: "#87CEEB",
                        fillToContainer: true,
                        autoPlay: false,
                        playButtonShowing: true,
                        playPauseAnimation: true,
                        allowTheatre: false,
                        keyboardControl: true,
                        controlBar: {
                            autoHide: true,
                            autoHideTimeout: 3,
                            animated: true
                        }
                    },
                    vastOptions: vastSettings
                });
                
                // Logika Judul (tidak berubah)
                player.on('play', () => document.getElementById('title-display').style.opacity = '0');
                player.on('pause', () => document.getElementById('title-display').style.opacity = '1');
                player.on('ended', () => document.getElementById('title-display').style.opacity = '1');

            } catch (e) {
                console.error("Error saat memuat data player:", e);
                document.getElementById('title-display').innerText = "ERROR: Data tidak valid.";
            }
        }
    });
</script>

</body>
</html>
